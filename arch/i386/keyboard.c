#include "const.h"
#include "i386.h"
#include "clock.h"
#include "interrupt.h"
#include "terminal.h"
#include "keyboard.h"

/* US keyboard keymap :: regular keys */
static const uint16_t regular[128] = {
	0x0000,0x011B,0x0231,0x0332,0x0433,0x0534,0x0635,0x0736,0x0837,0x0938,
	0x0A39,0x0B30,0x0C2D,0x0D3D,0x0E08,0x0F09,0x1071,0x1177,0x1265,0x1372,
	0x1474,0x1579,0x1675,0x1769,0x186F,0x1970,0x1A5B,0x1B5D,0x000D,0x1D00,
	0x1E61,0x1F73,0x2064,0x2166,0x2267,0x2368,0x246A,0x256B,0x266C,0x273B,
	0x2827,0x2960,0x2A00,0x2B5C,0x2C7A,0x2D78,0x2E63,0x2F76,0x3062,0x316E,
	0x326D,0x332C,0x342E,0x352F,0x3600,0x372A,0x3800,0x3920,0x3A00,0x3B00,
	0x3C00,0x3D00,0x3E00,0x3F00,0x4000,0x4100,0x4200,0x4300,0x4400,0x4500,
	0x4600,0x4700,0x4800,0x4900,0x4A2D,0x4B00,0x4C00,0x4D00,0x4E2B,0x4F00,
	0x5000,0x5100,0x5200,0x5300,0x5400,0x5500,0x5600,0x8500,0x8600,0x0000,
	0x0000,0x5B00,0x5C00,0x5D00
};

/* US keyboard keymap :: "with SHIFT" keys */
static const uint16_t with_shift[128] = {
	0x0000,0x011B,0x0221,0x0340,0x0423,0x0524,0x0625,0x075E,0x0826,0x092A,
	0x0A28,0x0B29,0x0C5F,0x0D2B,0x0E08,0x0F00,0x1051,0x1157,0x1245,0x1352,
	0x1454,0x1559,0x1655,0x1749,0x184F,0x1950,0x1A7B,0x1B7D,0x000D,0x1D00,
	0x1E41,0x1F53,0x2044,0x2146,0x2247,0x2348,0x244A,0x254B,0x264C,0x273A,
	0x2822,0x297E,0x2A00,0x2B7C,0x2C5A,0x2D58,0x2E43,0x2F56,0x3042,0x314E,
	0x324D,0x333C,0x343E,0x353F,0x3600,0x372A,0x3800,0x3920,0x3A00,0x5400,
	0x5500,0x5600,0x5700,0x5800,0x5900,0x5A00,0x5B00,0x5C00,0x5D00,0x4500,
	0x4600,0x4700,0x4800,0x4900,0x4A2D,0x4B00,0x4C00,0x4D00,0x4E2B,0x4F00,
	0x5000,0x5100,0x5200,0x5300,0x5400,0x5500,0x5600,0x8700,0x8800,0x0000,
	0x0000,0x5B00,0x5C00,0x5D00
};

/* US keyboard keymap :: "with ALT" keys */
static const uint16_t with_alt[128] = {
	0x0000,0x0100,0x7800,0x7900,0x7A00,0x7B00,0x7C00,0x7D00,0x7E00,0x7F00,
	0x8000,0x8100,0x8200,0x8300,0x0E00,0xA500,0x1000,0x1100,0x1200,0x1300,
	0x1400,0x1500,0x1600,0x1700,0x1800,0x1900,0x1A00,0x1B00,0x1C00,0x1D00,
	0x1E00,0x1F00,0x2000,0x2100,0x2200,0x2300,0x2400,0x2500,0x2600,0x2700,
	0x2800,0x2900,0x2A00,0x2B00,0x2C00,0x2D00,0x2E00,0x2F00,0x3000,0x3100,
	0x3200,0x3300,0x3400,0x3500,0x3600,0x3700,0x3800,0x3900,0x3A00,0x6800,
	0x6900,0x6A00,0x6B00,0x6C00,0x6D00,0x6E00,0x6F00,0x7000,0x7100,0x4500,
	0x4600,0x9700,0x9800,0x9900,0x4A00,0x9B00,0x9C00,0x9D00,0x4E00,0x9F00,
	0xA000,0xA100,0xA200,0xA300,0x5400,0x5500,0x5600,0x8B00,0x8C00
};

/* US keyboard keymap :: "with CTRL" keys */
static const uint16_t with_control[128] = {
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x9400,0x1011,0x1117,0x1205,0x1312,
	0x1414,0x1519,0x1615,0x1709,0x180F,0x1910,0x0000,0x0000,0x1C0A,0x1D00,
	0x1E01,0x1F13,0x2004,0x2106,0x2207,0x2308,0x240A,0x250B,0x260C,0x0000,
	0x0000,0x0000,0x2A00,0x0000,0x2C1A,0x2D18,0x2E03,0x2F16,0x3002,0x310E,
	0x320D,0x0000,0x0000,0x9500,0x3600,0x9600,0x3800,0x3920,0x3A00,0x5E00,
	0x5F00,0x6000,0x6100,0x6200,0x6300,0x6400,0x6500,0x6600,0x6700,0x4500,
	0x4600,0x7700,0x8D00,0x8400,0x8E00,0x7300,0x8F00,0x7400,0x9000,0x7500,
	0x9100,0x7600,0x9200,0x9300,0x5400,0x5500,0x5600,0x8900,0x8A00
};

static const uint8_t keypad_char[] = {
	'7','8','9','-','4','5','6','+','1','2','3','0','.'
};

static uint8_t shift = 0;
static uint8_t ctrl = 0;
static uint8_t alt = 0;
static uint8_t scroll_lock = 0;
static uint8_t caps_lock = 0;
static uint8_t num_lock = 0;

void keyb_wait_controller(void)
{
	int retries = 1000;
	while (((inb(KEYB_STATUS) & KEYB_BUSY) == KEYB_BUSY)) {
		delay(50);
		if (--retries == 0)
			break;
	}
}

uint16_t scan_key(void)
{
	static int code, val;
	uint32_t flags = local_irq_save();
	code = inb(KEYB_PORT);	/* Get scan code */
	val =  inb(KEYB_ACK);	/* Get keyboard acknowledge */
	outb(KEYB_ACK, val | 0x80); /* Disable bit 7 */
	outb(KEYB_ACK, val);	/* Send that back */
	local_irq_restore(flags);
	return code;
}

void update_leds(void)
{
	int leds;
	uint32_t flags = local_irq_save();
	leds =  (scroll_lock) | (num_lock << 1) | (caps_lock << 2);
	keyb_wait_controller();
	outb(KEYB_PORT, KEYB_LED_CODE);
	keyb_wait_controller();
	outb(KEYB_PORT, leds);
	local_irq_restore(flags);
}


void keyboard_handler(irq_context_t *c)
{
	uint16_t code;
	uint16_t keypressed = scan_key();
	/* If CTRL+ALT+Canc => Reboot the system */
	if (ctrl == 1 && alt == 1 && keypressed == DEL_SCAN) {
		cprintf("CTRL+ALT+DEL pressed!\n\r");
		return;
	}

	if (alt == 1) {
		code = with_alt[keypressed];
	} else if (ctrl == 1) {
		 code = with_control[keypressed];
	} else {
		if (caps_lock == 0 && shift == 0) {
			code = regular[keypressed];
		} else if (caps_lock == 0 && shift == 1) {
			code = with_shift[keypressed];
		} else if (caps_lock == 1 && shift == 0) {
			code = regular[keypressed];
			if (((code & 0xFF) >= 'a') && ((code & 0xFF) <= 'z'))
				code -= 'a'-'A';
		} else {
			code = with_shift[keypressed];
			if (((code & 0xFF) >= 'A') && ((code & 0xFF) <= 'Z'))
				code += 'a'-'A';
		}
		if ((num_lock != shift) && (keypressed >= 71 && keypressed <= 83))
			code = keypad_char[keypressed-71];
	}

	switch (keypressed) {
	case 42:	/* LShift */
		shift = 1;
		break;

	case (42+128):
		shift = 0;
		break;

	case 54:	/* RShift */
		shift = 1;
		break;

	case (54+128):
		shift = 0;
		break;

	case 56:	/* ALT */
		alt = 1;
		break;

	case (56+128):
		alt = 0;
		break;

	case 29:	/* CTRL */
		ctrl = 1;
		break;

	case (29+128):
		ctrl = 0;
		break;

	case 58:	/* CAPS LOCK */
		caps_lock ^= 1;
		update_leds();
		break;

	case 69:	/* NUM LOCK */
		num_lock ^= 1;
		update_leds();
		break;

	case 70:	/* SCROLL LOCK */
		scroll_lock ^= 1;
		update_leds();
		break;

	default:

		/*
		 * Update keyboard buffer. This is an interrupt
		 * handler so we are already in mutual exclusion!!!
		 */
		if (!(keypressed & 0x80)) {
			if (code == CTRL_C) {
				cprintf("IRQ 0x%x key-code: 0x%x "
					"system ticks: %u TSC: %u\n",
					c->irq, keypressed,
					sys_get_ticks(), rdtsc());
				return;
			}
			if (code == CTRL_X) {
				asm volatile ("int $0x0E");
			}
			if (keypressed == 0x1c) {
				terminal_putchar('\r');
				terminal_putchar('\n');
			} else
				terminal_putchar(code);
		}
		break;
	}
}

void __INIT__ init_keyboard()
{
	/* Set typematic delay as short as possible */
	outb(KEYB_PORT, KEYB_SET_TYPEMATIC);
	keyb_wait_controller();
	/* typematic 0 means "MODE CON RATE=30 DELAY=1" */
	outb(KEYB_PORT, 0);

	/* Initialize leds */
	update_leds();

	/* Install the keyboard handler */
	install_trap_handler(KEYBOARD_IRQ, (void *)&keyboard_handler);
}

